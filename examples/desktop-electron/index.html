<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="FortressAuth Electron Demo - Secure authentication example application">
  <title>FortressAuth Electron Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../shared/styles/index.css">
  <style>
    /* Electron-specific overrides */
    body {
      -webkit-app-region: drag;
    }
    .container {
      -webkit-app-region: no-drag;
    }
    /* Hide elements utility - using high specificity instead of !important */
    .hidden[class] {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <main id="main-content" class="container">
    <!-- Header -->
    <header class="header">
      <img src="../shared/assets/logo.svg" alt="" class="logo" aria-hidden="true">
      <h1 class="title">FortressAuth</h1>
      <p class="subtitle">Secure Authentication Demo</p>
    </header>

    <!-- Loading State -->
    <output id="loading" class="loading" aria-live="polite">
      <span class="loading-spinner" aria-hidden="true"></span>
      <span>Loading session...</span>
    </output>

    <!-- Auth Forms Section -->
    <section id="auth-section" class="hidden" aria-labelledby="auth-heading">
      <h2 id="auth-heading" class="sr-only">Authentication</h2>

      <!-- Tab Navigation -->
      <div class="tabs" role="tablist" aria-label="Authentication options">
        <button type="button" role="tab" class="tab active" id="signin-tab" aria-selected="true" aria-controls="auth-panel">Sign In</button>
        <button type="button" role="tab" class="tab" id="signup-tab" aria-selected="false" aria-controls="auth-panel">Sign Up</button>
        <button type="button" role="tab" class="tab" id="verify-tab" aria-selected="false" aria-controls="auth-panel">Verify</button>
        <button type="button" role="tab" class="tab" id="reset-tab" aria-selected="false" aria-controls="auth-panel">Reset</button>
      </div>

      <!-- Auth Form -->
      <form id="auth-form" novalidate role="tabpanel" id="auth-panel" aria-labelledby="signin-tab">
        <!-- Email Field -->
        <div id="email-group" class="form-group">
          <label for="email" class="form-label">
            Email <span class="form-required" aria-hidden="true">*</span>
          </label>
          <input 
            type="email" 
            id="email" 
            class="form-input" 
            placeholder="your@email.com" 
            autocomplete="email"
            aria-describedby="email-error"
            required
          >
          <div id="email-error" class="form-error hidden" role="alert"></div>
        </div>

        <!-- Token Field (for verify/reset modes) -->
        <div id="token-group" class="form-group hidden">
          <label for="token" class="form-label">
            <span id="token-label-text">Verification Token</span> <span class="form-required" aria-hidden="true">*</span>
          </label>
          <input 
            type="text" 
            id="token" 
            class="form-input" 
            placeholder="selector:verifier" 
            autocomplete="off"
            aria-describedby="token-hint token-error"
          >
          <div id="token-hint" class="form-hint">Paste the token from your email</div>
          <div id="token-error" class="form-error hidden" role="alert"></div>
        </div>

        <!-- Password Field -->
        <div id="password-group" class="form-group">
          <label for="password" class="form-label">
            <span id="password-label-text">Password</span> <span class="form-required" aria-hidden="true">*</span>
          </label>
          <input 
            type="password" 
            id="password" 
            class="form-input" 
            placeholder="••••••••" 
            autocomplete="current-password"
            aria-describedby="password-hint password-error"
          >
          <div id="password-hint" class="form-hint hidden">Minimum 8 characters</div>
          <div id="password-error" class="form-error hidden" role="alert"></div>
        </div>

        <!-- Confirm Password Field -->
        <div id="confirm-password-group" class="form-group hidden">
          <label for="confirm-password" class="form-label">
            Confirm Password <span class="form-required" aria-hidden="true">*</span>
          </label>
          <input 
            type="password" 
            id="confirm-password" 
            class="form-input" 
            placeholder="••••••••" 
            autocomplete="new-password"
            aria-describedby="confirm-password-error"
          >
          <div id="confirm-password-error" class="form-error hidden" role="alert"></div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submit-btn" class="btn btn-primary">
          <span id="submit-text">Sign In</span>
          <span id="submit-spinner" class="btn-spinner hidden" aria-hidden="true"></span>
        </button>

        <!-- Forgot Password Link -->
        <div id="forgot-password" class="forgot-password">
          <button type="button" id="forgot-link" class="link-button">Forgot your password?</button>
        </div>
      </form>

      <!-- Alert Container -->
      <div id="alert-container"></div>
    </section>

    <!-- Authenticated User Section -->
    <section id="user-section" class="authenticated hidden" aria-labelledby="welcome-heading">
      <h2 id="welcome-heading" class="sr-only">Welcome</h2>

      <div class="user-info">
        <p class="welcome-text">
          Welcome, <span id="user-email" class="user-email"></span>
        </p>

        <output class="verification-status">
          <span id="verification-badge" class="status-badge"></span>
        </output>
      </div>

      <button type="button" id="signout-btn" class="btn btn-secondary">
        <span id="signout-text">Sign Out</span>
        <span id="signout-spinner" class="btn-spinner hidden" aria-hidden="true"></span>
      </button>

      <!-- Alert Container for authenticated state -->
      <div id="user-alert-container"></div>
    </section>

    <!-- Password Reset Modal -->
    <div id="reset-modal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="reset-modal-title">
      <div class="modal" tabindex="-1">
        <div class="modal-header">
          <h3 id="reset-modal-title" class="modal-title">Reset Password</h3>
          <button type="button" id="reset-modal-close" class="modal-close" aria-label="Close">&times;</button>
        </div>
        <p class="modal-description">Enter your email address and we'll send you a link to reset your password.</p>
        
        <div class="form-group">
          <label for="reset-email" class="form-label">
            Email <span class="form-required" aria-hidden="true">*</span>
          </label>
          <input 
            type="email" 
            id="reset-email" 
            class="form-input" 
            placeholder="your@email.com" 
            autocomplete="email"
            aria-describedby="reset-email-error"
          >
          <div id="reset-email-error" class="form-error hidden" role="alert"></div>
        </div>

        <div class="modal-actions">
          <button type="button" id="reset-send-btn" class="btn btn-primary">
            <span id="reset-send-text">Send Reset Link</span>
            <span id="reset-send-spinner" class="btn-spinner hidden" aria-hidden="true"></span>
          </button>
          <button type="button" id="reset-cancel-btn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Import validation utilities (compiled JS version)
    const validation = require('../shared/utils/validation.js');
    const { createAuth } = require('@fortressauth/electron-sdk');

    // Get API URL from environment or use default
    const API_URL = process.env.FORTRESSAUTH_API_URL || 'http://localhost:3000';
    const auth = createAuth({ baseUrl: API_URL });

    // Current mode
    let mode = 'signin';
    let isSubmitting = false;

    // DOM Elements
    const elements = {
      // Sections
      loading: document.getElementById('loading'),
      authSection: document.getElementById('auth-section'),
      userSection: document.getElementById('user-section'),
      
      // Tabs
      signinTab: document.getElementById('signin-tab'),
      signupTab: document.getElementById('signup-tab'),
      verifyTab: document.getElementById('verify-tab'),
      resetTab: document.getElementById('reset-tab'),
      
      // Form
      authForm: document.getElementById('auth-form'),
      
      // Form groups
      emailGroup: document.getElementById('email-group'),
      tokenGroup: document.getElementById('token-group'),
      passwordGroup: document.getElementById('password-group'),
      confirmPasswordGroup: document.getElementById('confirm-password-group'),
      forgotPassword: document.getElementById('forgot-password'),
      
      // Inputs
      email: document.getElementById('email'),
      token: document.getElementById('token'),
      password: document.getElementById('password'),
      confirmPassword: document.getElementById('confirm-password'),
      
      // Labels
      tokenLabelText: document.getElementById('token-label-text'),
      passwordLabelText: document.getElementById('password-label-text'),
      passwordHint: document.getElementById('password-hint'),
      
      // Errors
      emailError: document.getElementById('email-error'),
      tokenError: document.getElementById('token-error'),
      passwordError: document.getElementById('password-error'),
      confirmPasswordError: document.getElementById('confirm-password-error'),
      
      // Buttons
      submitBtn: document.getElementById('submit-btn'),
      submitText: document.getElementById('submit-text'),
      submitSpinner: document.getElementById('submit-spinner'),
      forgotLink: document.getElementById('forgot-link'),
      
      // User section
      userEmail: document.getElementById('user-email'),
      verificationBadge: document.getElementById('verification-badge'),
      signoutBtn: document.getElementById('signout-btn'),
      signoutText: document.getElementById('signout-text'),
      signoutSpinner: document.getElementById('signout-spinner'),
      
      // Alert containers
      alertContainer: document.getElementById('alert-container'),
      userAlertContainer: document.getElementById('user-alert-container'),
      
      // Reset modal
      resetModal: document.getElementById('reset-modal'),
      resetModalClose: document.getElementById('reset-modal-close'),
      resetEmail: document.getElementById('reset-email'),
      resetEmailError: document.getElementById('reset-email-error'),
      resetSendBtn: document.getElementById('reset-send-btn'),
      resetSendText: document.getElementById('reset-send-text'),
      resetSendSpinner: document.getElementById('reset-send-spinner'),
      resetCancelBtn: document.getElementById('reset-cancel-btn'),
    };

    // Utility functions
    function showElement(el) {
      el.classList.remove('hidden');
    }

    function hideElement(el) {
      el.classList.add('hidden');
    }

    function setInputError(input, errorEl, message) {
      if (message) {
        input.classList.add('input-error');
        errorEl.textContent = message;
        showElement(errorEl);
      } else {
        input.classList.remove('input-error');
        errorEl.textContent = '';
        hideElement(errorEl);
      }
    }

    function clearAllErrors() {
      setInputError(elements.email, elements.emailError, '');
      setInputError(elements.token, elements.tokenError, '');
      setInputError(elements.password, elements.passwordError, '');
      setInputError(elements.confirmPassword, elements.confirmPasswordError, '');
    }

    function setSubmitting(submitting) {
      isSubmitting = submitting;
      elements.submitBtn.disabled = submitting;
      elements.email.disabled = submitting;
      elements.token.disabled = submitting;
      elements.password.disabled = submitting;
      elements.confirmPassword.disabled = submitting;
      
      if (submitting) {
        showElement(elements.submitSpinner);
      } else {
        hideElement(elements.submitSpinner);
      }
      
      updateSubmitButtonText();
    }

    function setSignoutSubmitting(submitting) {
      elements.signoutBtn.disabled = submitting;
      
      if (submitting) {
        elements.signoutText.textContent = 'Signing out...';
        showElement(elements.signoutSpinner);
      } else {
        elements.signoutText.textContent = 'Sign Out';
        hideElement(elements.signoutSpinner);
      }
    }

    function createAlert(type, message, container) {
      // Clear existing alerts
      container.innerHTML = '';
      
      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'ℹ'
      };
      
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.setAttribute('role', 'alert');
      alert.innerHTML = `
        <span class="alert-icon" aria-hidden="true">${icons[type]}</span>
        <span class="alert-message">${message}</span>
        <button type="button" class="alert-dismiss" aria-label="Dismiss">&times;</button>
      `;
      
      const dismissBtn = alert.querySelector('.alert-dismiss');
      dismissBtn.addEventListener('click', () => {
        alert.remove();
      });
      
      container.appendChild(alert);
    }

    function showAlert(type, message) {
      const container = elements.userSection.classList.contains('hidden') 
        ? elements.alertContainer 
        : elements.userAlertContainer;
      createAlert(type, message, container);
    }

    function clearAlerts() {
      elements.alertContainer.innerHTML = '';
      elements.userAlertContainer.innerHTML = '';
    }

    function getErrorMessage(error) {
      return validation.getErrorMessage(error);
    }

    function updateSubmitButtonText() {
      const loadingTexts = {
        signin: 'Signing in...',
        signup: 'Creating account...',
        verify: 'Verifying...',
        reset: 'Resetting password...'
      };
      
      const buttonTexts = {
        signin: 'Sign In',
        signup: 'Create Account',
        verify: 'Verify Email',
        reset: 'Reset Password'
      };
      
      elements.submitText.textContent = isSubmitting ? loadingTexts[mode] : buttonTexts[mode];
    }

    // Mode switching
    function setMode(newMode) {
      mode = newMode;
      clearAllErrors();
      clearAlerts();
      
      // Update tabs
      [elements.signinTab, elements.signupTab, elements.verifyTab, elements.resetTab].forEach(tab => {
        tab.classList.remove('active');
        tab.setAttribute('aria-selected', 'false');
      });
      
      const activeTab = document.getElementById(`${mode}-tab`);
      activeTab.classList.add('active');
      activeTab.setAttribute('aria-selected', 'true');
      
      // Update form fields visibility
      hideElement(elements.emailGroup);
      hideElement(elements.tokenGroup);
      hideElement(elements.passwordGroup);
      hideElement(elements.confirmPasswordGroup);
      hideElement(elements.forgotPassword);
      hideElement(elements.passwordHint);
      
      switch (mode) {
        case 'signin':
          showElement(elements.emailGroup);
          showElement(elements.passwordGroup);
          showElement(elements.forgotPassword);
          elements.password.autocomplete = 'current-password';
          elements.passwordLabelText.textContent = 'Password';
          break;
          
        case 'signup':
          showElement(elements.emailGroup);
          showElement(elements.passwordGroup);
          showElement(elements.confirmPasswordGroup);
          showElement(elements.passwordHint);
          elements.password.autocomplete = 'new-password';
          elements.passwordLabelText.textContent = 'Password';
          break;
          
        case 'verify':
          showElement(elements.tokenGroup);
          elements.tokenLabelText.textContent = 'Verification Token';
          break;
          
        case 'reset':
          showElement(elements.tokenGroup);
          showElement(elements.passwordGroup);
          showElement(elements.confirmPasswordGroup);
          showElement(elements.passwordHint);
          elements.tokenLabelText.textContent = 'Reset Token';
          elements.password.autocomplete = 'new-password';
          elements.passwordLabelText.textContent = 'New Password';
          break;
      }
      
      updateSubmitButtonText();
    }

    // Form validation
    function validateForm() {
      let errors = {};
      
      const sanitizedEmail = validation.sanitizeInput(elements.email.value);
      const sanitizedToken = validation.sanitizeInput(elements.token.value);
      
      switch (mode) {
        case 'signin':
          errors = validation.validateSignInForm(sanitizedEmail, elements.password.value);
          break;
        case 'signup':
          errors = validation.validateSignUpForm(sanitizedEmail, elements.password.value, elements.confirmPassword.value);
          break;
        case 'verify':
          errors = validation.validateVerifyEmailForm(sanitizedToken);
          break;
        case 'reset':
          errors = validation.validateResetPasswordForm(sanitizedToken, elements.password.value, elements.confirmPassword.value);
          break;
      }
      
      // Display errors
      setInputError(elements.email, elements.emailError, errors.email);
      setInputError(elements.token, elements.tokenError, errors.token);
      setInputError(elements.password, elements.passwordError, errors.password);
      setInputError(elements.confirmPassword, elements.confirmPasswordError, errors.confirmPassword);
      
      return !validation.hasErrors(errors);
    }

    // Form submission
    async function handleSubmit(e) {
      e.preventDefault();
      clearAlerts();
      
      if (!validateForm()) {
        return;
      }
      
      setSubmitting(true);
      
      const sanitizedEmail = validation.sanitizeInput(elements.email.value);
      const sanitizedToken = validation.sanitizeInput(elements.token.value);
      
      try {
        switch (mode) {
          case 'signup': {
            const res = await auth.signUp(sanitizedEmail, elements.password.value);
            if (res.success) {
              showAlert('success', 'Account created! Please check your email for verification.');
              resetForm();
            } else {
              showAlert('error', getErrorMessage(res.error));
            }
            break;
          }
          
          case 'signin': {
            const res = await auth.signIn(sanitizedEmail, elements.password.value);
            if (res.success) {
              showAlert('success', 'Welcome back!');
              resetForm();
            } else {
              showAlert('error', getErrorMessage(res.error));
            }
            break;
          }
          
          case 'verify': {
            const res = await auth.verifyEmail(sanitizedToken);
            if (res.success) {
              showAlert('success', 'Email verified successfully! You can now sign in.');
              elements.token.value = '';
              setMode('signin');
            } else {
              showAlert('error', getErrorMessage(res.error));
            }
            break;
          }
          
          case 'reset': {
            const res = await auth.resetPassword(sanitizedToken, elements.password.value);
            if (res.success) {
              showAlert('success', 'Password reset successful! Please sign in with your new password.');
              resetForm();
              setMode('signin');
            } else {
              showAlert('error', getErrorMessage(res.error));
            }
            break;
          }
        }
      } catch (_err) {
        showAlert('error', 'An unexpected error occurred. Please try again.');
      } finally {
        setSubmitting(false);
      }
    }

    function resetForm() {
      elements.email.value = '';
      elements.password.value = '';
      elements.confirmPassword.value = '';
      elements.token.value = '';
      clearAllErrors();
    }

    // Password reset modal
    function openResetModal() {
      elements.resetEmail.value = elements.email.value;
      setInputError(elements.resetEmail, elements.resetEmailError, '');
      showElement(elements.resetModal);
      elements.resetEmail.focus();
    }

    function closeResetModal() {
      hideElement(elements.resetModal);
    }

    async function handleRequestReset() {
      const sanitizedEmail = validation.sanitizeInput(elements.resetEmail.value);
      const emailValidation = validation.validateEmail(sanitizedEmail);
      
      if (!emailValidation.isValid) {
        setInputError(elements.resetEmail, elements.resetEmailError, emailValidation.error);
        return;
      }
      
      setInputError(elements.resetEmail, elements.resetEmailError, '');
      
      // Set loading state
      elements.resetSendBtn.disabled = true;
      elements.resetSendText.textContent = 'Sending...';
      showElement(elements.resetSendSpinner);
      
      try {
        const res = await auth.requestPasswordReset(sanitizedEmail);
        if (res.success) {
          showAlert('success', 'If an account exists with this email, you will receive a password reset link.');
          closeResetModal();
          elements.email.value = '';
        } else {
          showAlert('error', getErrorMessage(res.error));
        }
      } catch (_err) {
        showAlert('error', 'An unexpected error occurred. Please try again.');
      } finally {
        elements.resetSendBtn.disabled = false;
        elements.resetSendText.textContent = 'Send Reset Link';
        hideElement(elements.resetSendSpinner);
      }
    }

    // Sign out
    async function handleSignOut() {
      setSignoutSubmitting(true);
      
      try {
        await auth.signOut();
        showAlert('info', 'You have been signed out.');
      } catch (_err) {
        showAlert('error', 'Failed to sign out. Please try again.');
      } finally {
        setSignoutSubmitting(false);
      }
    }

    // Update UI based on auth state
    function updateUI(state) {
      hideElement(elements.loading);
      
      if (state.loading) {
        showElement(elements.loading);
        hideElement(elements.authSection);
        hideElement(elements.userSection);
        return;
      }
      
      if (state.user) {
        hideElement(elements.authSection);
        showElement(elements.userSection);
        
        elements.userEmail.textContent = state.user.email;
        
        if (state.user.emailVerified) {
          elements.verificationBadge.className = 'status-badge status-verified';
          elements.verificationBadge.textContent = '✓ Email Verified';
        } else {
          elements.verificationBadge.className = 'status-badge status-unverified';
          elements.verificationBadge.textContent = '⚠ Email Not Verified';
        }
      } else {
        showElement(elements.authSection);
        hideElement(elements.userSection);
      }
      
      if (state.error && !state.user) {
        showAlert('error', getErrorMessage(state.error));
      }
    }

    // Event listeners
    elements.signinTab.addEventListener('click', () => setMode('signin'));
    elements.signupTab.addEventListener('click', () => setMode('signup'));
    elements.verifyTab.addEventListener('click', () => setMode('verify'));
    elements.resetTab.addEventListener('click', () => setMode('reset'));

    elements.authForm.addEventListener('submit', handleSubmit);
    elements.forgotLink.addEventListener('click', openResetModal);
    elements.signoutBtn.addEventListener('click', handleSignOut);

    elements.resetModalClose.addEventListener('click', closeResetModal);
    elements.resetCancelBtn.addEventListener('click', closeResetModal);
    elements.resetSendBtn.addEventListener('click', handleRequestReset);

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !elements.resetModal.classList.contains('hidden')) {
        closeResetModal();
      }
    });

    // Close modal on overlay click
    elements.resetModal.addEventListener('click', (e) => {
      if (e.target === elements.resetModal) {
        closeResetModal();
      }
    });

    // Subscribe to auth state changes
    auth.subscribe(updateUI);

    // Initialize mode
    setMode('signin');
  </script>
</body>
</html>
